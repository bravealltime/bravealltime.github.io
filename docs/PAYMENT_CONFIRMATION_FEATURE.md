# ระบบยืนยันการชำระเงิน (Payment Confirmation System)

## ภาพรวม

ระบบยืนยันการชำระเงินเป็นฟีเจอร์ที่ช่วยให้เจ้าของห้องสามารถยืนยันการชำระเงินของลูกบ้านได้ และหลังจากยืนยันแล้ว ลูกบ้านจะไม่สามารถลบหลักฐานการชำระเงินหรือแถวข้อมูลได้อีกต่อไป

## การทำงานของระบบ

### 1. ขั้นตอนการทำงาน

1. **ลูกบ้านอัปโหลดหลักฐานการชำระเงิน**
   - ลูกบ้าน (Role: `level1_tenant`) สามารถอัปโหลดหลักฐานการชำระเงินได้
   - หลักฐานจะถูกบันทึกใน Firebase Storage และ URL จะถูกเก็บในฐานข้อมูล

2. **เจ้าของห้องเห็นปุ่มยืนยัน**
   - เจ้าของห้อง (Role: `1`) จะเห็นปุ่ม <i class="fas fa-check-circle"></i> "ยืนยันการชำระเงิน"
   - ปุ่มจะแสดงเฉพาะเมื่อมีหลักฐานและยังไม่ได้รับการยืนยัน

3. **เจ้าของห้องยืนยันการชำระเงิน**
   - เจ้าของห้องกดปุ่มยืนยัน
   - ระบบจะแสดงข้อความยืนยันก่อนดำเนินการ
   - ข้อมูลจะถูกอัปเดตในฐานข้อมูล

4. **ล็อคข้อมูล**
   - หลังจากยืนยันแล้ว ลูกบ้านจะไม่สามารถลบหลักฐานได้
   - หลังจากยืนยันแล้ว ลูกบ้านจะไม่สามารถลบแถวข้อมูลได้
   - ปุ่มลบหลักฐานและปุ่มลบแถวจะหายไป
   - แสดงไอคอน <i class="fas fa-check-circle"></i> สีเขียวแทน

### 2. สิทธิ์การใช้งาน

#### เจ้าของห้อง (Role: `1`)
- ✅ อัปโหลดหลักฐานการชำระเงิน
- ✅ ยืนยันการชำระเงิน
- ✅ ลบหลักฐาน (ก่อนยืนยัน)
- ✅ ลบแถวข้อมูล (ก่อนยืนยัน)
- ✅ ดูประวัติห้องที่จัดการ

#### ลูกบ้าน (Role: `level1_tenant`)
- ✅ อัปโหลดหลักฐานการชำระเงิน
- ✅ ลบหลักฐาน (ก่อนเจ้าของยืนยัน)
- ✅ ลบแถวข้อมูล (ก่อนเจ้าของยืนยัน)
- ✅ ดูประวัติห้องที่เข้าถึงได้
- ❌ ไม่สามารถยืนยันการชำระเงินได้
- ❌ ไม่สามารถลบหลักฐานหลังจากเจ้าของยืนยันแล้ว
- ❌ ไม่สามารถลบแถวข้อมูลหลังจากเจ้าของยืนยันแล้ว

#### แอดมิน (Role: `admin`)
- ✅ ทุกสิทธิ์ของเจ้าของห้อง
- ✅ ยืนยันการชำระเงินสำหรับทุกห้อง
- ✅ ลบหลักฐานและแถวข้อมูลได้เสมอ (แม้หลังยืนยันแล้ว)

## การแสดงผล

### ในตารางประวัติ (index.html)

| สถานะ | การแสดงผล | คำอธิบาย |
|-------|-----------|----------|
| ไม่มีหลักฐาน | <i class="fas fa-upload text-green-400"></i> + <i class="fas fa-trash text-red-400"></i> | ปุ่มอัปโหลดหลักฐาน + ปุ่มลบแถว |
| มีหลักฐาน ยังไม่ยืนยัน | <i class="fas fa-check-circle text-emerald-400"></i> + <i class="fas fa-trash-alt text-orange-400"></i> + <i class="fas fa-trash text-red-400"></i> | ปุ่มยืนยัน + ปุ่มลบหลักฐาน + ปุ่มลบแถว |
| ยืนยันแล้ว | <i class="fas fa-check-circle text-emerald-400"></i> | ไอคอนยืนยัน (ไม่สามารถกดได้) |

### ในบัตรห้อง (home.html)

เมื่อการชำระเงินได้รับการยืนยันแล้ว จะแสดงข้อความ:
```
✓ ยืนยันการชำระเงินแล้ว
```

## โครงสร้างข้อมูล

### ฟิลด์ใหม่ในฐานข้อมูล

```javascript
{
  // ฟิลด์เดิม...
  paymentConfirmed: true,                    // สถานะการยืนยัน
  paymentConfirmedAt: "2024-12-01T10:30:00.000Z",  // เวลาที่ยืนยัน
  paymentConfirmedBy: "user_uid_here"        // ผู้ยืนยัน
}
```

## ฟังก์ชันที่เพิ่มใหม่

### 1. `confirmPayment(key)`
ฟังก์ชันสำหรับยืนยันการชำระเงิน

**พารามิเตอร์:**
- `key`: คีย์ของบิลที่ต้องการยืนยัน

**การทำงาน:**
- ตรวจสอบสิทธิ์การยืนยัน
- ตรวจสอบว่ามีหลักฐานหรือไม่
- ตรวจสอบว่ายืนยันแล้วหรือยัง
- อัปเดตฐานข้อมูล
- รีเฟรชการแสดงผล

### 2. การปรับปรุง `deleteEvidence(key)`
เพิ่มการตรวจสอบสถานะการยืนยันก่อนลบหลักฐาน

### 3. การปรับปรุง `deleteBill(key)` และ `confirmDelete()`
เพิ่มการตรวจสอบสถานะการยืนยันก่อนลบแถวข้อมูล

### 4. การปรับปรุง `renderHistoryTable(room)`
เพิ่มการแสดงปุ่มยืนยันและสถานะการยืนยัน
ซ่อนปุ่มลบหลักฐานและปุ่มลบแถวเมื่อยืนยันแล้ว

### 5. การปรับปรุง `renderHomeRoomCards()`
เพิ่มการแสดงสถานะการยืนยันในบัตรห้อง

## การตั้งค่าสิทธิ์

### เพิ่มสิทธิ์ใหม่ใน `auth.js`

```javascript
const ROLE_PERMISSIONS = {
  'admin': {
    // สิทธิ์เดิม...
    canConfirmPayment: true,  // แอดมินสามารถยืนยันได้ทุกห้อง
  },
  '1': { // เจ้าของห้อง
    // สิทธิ์เดิม...
    canConfirmPayment: true,  // เจ้าของห้องสามารถยืนยันได้
  },
  'level1_tenant': { // ลูกบ้าน
    // สิทธิ์เดิม...
    canConfirmPayment: false, // ลูกบ้านไม่สามารถยืนยันได้
  }
};
```

## ข้อความแจ้งเตือน

### ข้อความเมื่อไม่สามารถลบหลักฐานได้
```
"ไม่สามารถลบหลักฐานได้ เนื่องจากเจ้าของห้องได้ยืนยันการชำระเงินแล้ว"
```

### ข้อความเมื่อไม่สามารถลบแถวข้อมูลได้
```
"ไม่สามารถลบข้อมูลได้ เนื่องจากเจ้าของห้องได้ยืนยันการชำระเงินแล้ว"
```

### ข้อความเมื่อยืนยันการชำระเงิน
```
"คุณแน่ใจหรือไม่ว่าต้องการยืนยันการชำระเงินนี้? หลังจากยืนยันแล้ว ลูกบ้านจะไม่สามารถลบหลักฐานและข้อมูลได้"
```

### ข้อความเมื่อยืนยันสำเร็จ
```
"ยืนยันการชำระเงินเรียบร้อยแล้ว"
```

## การทดสอบ

เปิดไฟล์ `test-payment-confirmation.html` เพื่อดูตัวอย่างการทำงานของระบบ

## หมายเหตุ

- ระบบนี้ช่วยป้องกันการลบหลักฐานและข้อมูลโดยไม่ได้รับอนุญาต
- เจ้าของห้องสามารถยืนยันได้เฉพาะห้องที่ตนเองจัดการ
- แอดมินสามารถยืนยันและลบได้ทุกห้อง (แม้หลังยืนยันแล้ว)
- การยืนยันไม่สามารถยกเลิกได้ (เพื่อความปลอดภัยของข้อมูล)
- หลังยืนยันแล้ว ลูกบ้านไม่สามารถลบได้ทั้งหลักฐานและแถวข้อมูล 